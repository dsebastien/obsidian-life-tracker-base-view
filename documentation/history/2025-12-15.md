# 2025-12-15 Session

## Completed

### Fix: Internal Obsidian Metadata Filtering for Charts

Fixed pie, doughnut, and polar area charts displaying internal Obsidian metadata (`{"icon": "lucide..."}`) as labels instead of actual values.

**Root Cause**: Obsidian includes internal metadata objects (link icons, subpaths) in property values. These were being stringified and displayed as labels.

**Solution**: Updated `formatValueForDisplay` (value.utils.ts) and `valueToLabel` (chart-aggregation.utils.ts) to:

1. First try to extract `display` value from Obsidian link objects (priority: display > value > name > label > text)
2. Fall back to extracting filename from `path` property for links without display text
3. Only skip internal metadata objects (icon, subpath) if no displayable value can be extracted
4. Recursively process stringified JSON objects with internal markers
5. Added MAX_VALUE_DEPTH (10) to prevent infinite recursion
6. Removed excessive debug logging that was causing performance issues
7. **Critical fix**: Changed `aggregateForPieChart` to use raw value from `entry.getValue(propertyId)` instead of pre-formatted `point.value` - this is consistent with how tag cloud works and ensures the raw Obsidian data is properly processed

### Fix: Property Removal Detection

Updated `canDoIncrementalUpdate` in `life-tracker-view.ts` to detect when visualizations exist for properties that are no longer in the view, triggering a full refresh.

### Fix: Visualization Type Switching

Added `visualizationTypes` map to track what type each visualization is. When switching from heatmap to line chart (etc.), the type change is detected and triggers a full refresh.

### Fix: Area vs Line Chart Differentiation

Added `fill?: boolean` property to `ChartConfig` interface:

- Line charts: `fill: false`
- Area charts: `fill: true`

Updated `chart-initializers.ts` to use `chartConfig.fill` instead of hacky type detection.

### Fix: CSS Grid Conflict

Fixed duplicate `.lt-grid` CSS class definitions causing conflicts between card grid and heatmap grid. Moved heatmap grid styling to specific classes: `.lt-heatmap-grid--monthly` and `.lt-heatmap-grid--quarterly`.

### Fix: Logging Tests

Fixed tests to expect `console.debug` for 'info' level. Obsidian disallows both `console.log` and `console.info`, so the log function correctly uses `console.debug` for both 'debug' and 'info' levels.

## Files Modified

- `src/utils/log.utils.spec.ts` - Fix tests to expect console.debug for info level
- `src/utils/value.utils.ts` - Robust internal Obsidian object detection
- `src/utils/value.utils.spec.ts` - Tests for stringified JSON detection
- `src/app/services/chart-aggregation.utils.ts` - Same filtering in valueToLabel
- `src/app/view/life-tracker-view.ts` - Property removal and type change detection
- `src/app/types/visualization/visualization.types.ts` - Added `fill` to ChartConfig
- `src/app/view/visualization-config.helper.ts` - Separate Line/Area configs
- `src/app/components/visualizations/chart/chart-initializers.ts` - Use fill config
- `src/styles.src.css` - Fix CSS grid conflict
- `src/app/components/visualizations/heatmap/heatmap-renderer.ts` - Remove conflicting classes

## Test Results

- All 343 tests pass (89 value.utils tests)
- TypeScript compilation: 0 errors
- Lint: 0 warnings

---

### Fix: Consistent Chart Sizing Across All Chart Types

Fixed pie, doughnut, radar, and polar area charts rendering larger/taller than other chart types (line, bar, heatmap).

**Root Cause**: Different chart types had different aspect ratios:

- Pie/Doughnut/PolarArea/Radar: 1.5 (taller)
- Cartesian (line, bar, area): 2.5 (wider)
- Scatter/Bubble: 2.0 (middle)

**Solution**:

1. Normalized all chart aspect ratios to 2.0 for consistent sizing
2. Added CSS flex constraints to ensure charts fill their cards without overflow:
    - `.lt-card > .lt-section`: Added `min-h-0` for proper flex shrinking
    - `.lt-chart`: Added `flex-1` and `min-height: 0` for flex behavior
    - `.lt-chart-canvas`: Added `max-height: 100%` to prevent overflow

## Files Modified

- `src/app/components/visualizations/chart/chart-initializers.ts` - Normalized aspect ratios to 2.0
- `src/styles.src.css` - Added flex constraints for consistent chart sizing

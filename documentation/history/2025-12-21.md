# 2025-12-21

## Completed

### Overlay Charts (Multi-Property Visualization)

Implemented the ability to display multiple properties on a single chart:

- Added `OverlayVisualizationConfig` type with `propertyIds[]`, display name, and visualization type
- Extended `ChartDataset` with optional `propertyId` field for dataset identification
- Created `aggregateForOverlayChart()` in chart aggregation utilities - aligns timestamps across multiple properties
- Added overlay config management to ColumnConfigService: create, update, delete, list
- Created `PropertySelectionModal` for selecting properties to include in overlay (requires 2+ properties)
- Added "Create overlay" button to card context menu (only for supported chart types: LineChart, BarChart, AreaChart)
- Integrated overlay rendering in LifeTrackerView - overlays render after individual property cards
- Added `renderChartData()` method to ChartVisualization for pre-aggregated data
- Overlays always show legends to identify each property's line/bar

### Property Removal Cleanup

Implemented automatic cleanup of orphaned configs when properties are removed from Base:

- Added `cleanupOrphanedConfigs()` to ColumnConfigService
- Cleanup runs after each full view re-render in `onDataUpdated()`
- Also cleans overlay configs - removes deleted properties from overlays
- If overlay drops below 2 properties, the entire overlay is deleted

### UI Improvements

- **Create Overlay button**: Moved from card context menu to control bar (next to time frame dropdown)
- **Property Selection Modal**: Made dropdown taller (36px height) and fully responsive with mobile breakpoint
- **Overlay Edit Modal**: Created new comprehensive modal for editing overlays with:
    - Display name input for renaming
    - Visual chart type selector (Line/Bar/Area with icons)
    - Property checkboxes with minimum 2 validation
    - Delete button with confirmation dialog
    - Full responsive design with mobile breakpoint at 520px
- Removed old `showOverlayContextMenu()` function - replaced by OverlayEditModal

### Bug Fixes

- **Overlay not appearing immediately**: Modified `canDoIncrementalUpdate()` to detect overlay config changes and force full re-render when overlays are added/removed
- Added `setupOverlayCardEventHandlers()` for right-click and long-touch support on overlay cards

## Files Modified

- `src/app/types/column/column-config.types.ts` - OverlayVisualizationConfig, supportsOverlay()
- `src/app/types/visualization/visualization.types.ts` - ChartDataset.propertyId
- `src/app/types/ui/card-menu-action.intf.ts` - Overlay menu actions
- `src/app/services/chart-aggregation.utils.ts` - aggregateForOverlayChart()
- `src/app/services/data-aggregation.service.ts` - Exposed overlay aggregation method
- `src/app/view/column-config.service.ts` - Overlay config methods, cleanupOrphanedConfigs()
- `src/app/view/life-tracker-view.ts` - Overlay rendering, cleanup integration, action handlers, overlay event handlers
- `src/app/components/modals/property-selection-modal.ts` - New file
- `src/app/components/modals/overlay-edit-modal.ts` - New file (edit overlay modal)
- `src/app/components/ui/card-context-menu.ts` - Removed showOverlayContextMenu()
- `src/app/components/ui/grid-controls.ts` - Added "Create overlay" button
- `src/app/components/visualizations/chart/chart-visualization.ts` - renderChartData()
- `src/styles.src.css` - Modal styles, overlay context menu styles
- `documentation/Business Rules.md` - Overlay and cleanup rules
